<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>백엔드 API 테스트 페이지</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #result { margin-top: 20px; border: 1px solid #ccc; padding: 15px; }
        img { max-width: 400px; border: 2px solid green; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>포토부스 백엔드 테스트</h1>
    <p>아래 버튼을 누르면 웹캠 없이 가짜 이미지 데이터를 생성하여 /capture API로 전송합니다.</p>
    
    <button onclick="sendTestData()">백엔드로 사진 데이터 전송 테스트</button>

    <div id="result">
        <h2>결과:</h2>
        <p id="message">아직 요청하지 않았습니다.</p>
        <div id="image-container"></div>
    </div>

    <script>
        // ========================= [수정된 스크립트 시작] =========================

        // 1. 가짜 이미지(파란색 사각형)를 Base64 데이터로 직접 생성하는 함수
        function createDummyImageBase64() {
            // HTML5 canvas를 메모리에 생성합니다.
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');

            // 파란색 배경을 칠합니다.
            ctx.fillStyle = 'blue';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 흰색으로 글씨를 씁니다.
            ctx.fillStyle = 'white';
            ctx.font = '30px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Test Image', canvas.width / 2, canvas.height / 2);
            
            // canvas에 그려진 이미지를 JPEG 형식의 Base64 데이터로 변환하여 반환합니다.
            return canvas.toDataURL('image/jpeg');
        }

        // 2. 버튼을 눌렀을 때 실행되는 메인 함수
        async function sendTestData() {
            const messageEl = document.getElementById('message');
            const imageContainerEl = document.getElementById('image-container');

            messageEl.textContent = '가짜 이미지 데이터를 생성하고 서버로 전송하는 중...';
            imageContainerEl.innerHTML = '';

            try {
                // 외부 사이트에서 이미지를 가져오는 대신, 직접 생성한 Base64 데이터를 사용합니다.
                const base64data = createDummyImageBase64();
                
                // 백엔드 /capture API로 POST 요청을 보냅니다.
                const backendResponse = await fetch('http://127.0.0.1:5000/capture', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: base64data }),
                });

                const result = await backendResponse.json();

                if (!backendResponse.ok) {
                    // 서버가 4xx, 5xx 에러를 응답했을 때 실행됩니다.
                    throw new Error(result.message || '서버에서 오류 응답을 받았습니다.');
                }
                
                // 성공 결과를 화면에 표시합니다.
                messageEl.textContent = `서버 응답: ${result.message}`;
                
                const newImage = document.createElement('img');
                newImage.src = result.imageUrl; 
                imageContainerEl.appendChild(newImage);

            } catch (error) {
                // fetch 자체가 실패하거나(네트워크 끊김 등), 위에서 던진 에러를 여기서 잡습니다.
                console.error("오류 상세 정보:", error);
                messageEl.textContent = `오류 발생: ${error.message}`;
            }
        }
        // ========================= [수정된 스크립트 끝] =========================
    </script>
</body>
</html>